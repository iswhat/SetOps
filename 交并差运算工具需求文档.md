# 本地千万级数据交并差运算工具需求文档

## 1. 项目背景

### 1.1 项目概述
开发一款本地运行的数据分析工具，用于处理两组千万行级别的数据，执行交并差运算，对本地配置要求不高，界面简洁现代，执行流畅，支持Windows平台。

### 1.2 问题描述
- **数据规模大**：需要处理千万行级别的数据，传统工具处理速度慢或内存不足
- **多文件处理**：同一组数据可能分散在多个文件中，需要合并去重
- **实时反馈**：处理过程需要实时显示进度，让用户了解执行状态
- **性能优化**：需要通过时间换效率，同时保证处理速度
- **跨平台支持**：优先支持Windows平台，生成桌面应用程序

### 1.3 技术选型
- **后端**：Python + SQLite
- **前端**：Electron + Vue 3 + Vite
- **核心依赖**：pandas、SQLite、WebSocket、electron-builder

## 2. 功能需求

### 2.1 数据导入
- **F001**：支持多种文件格式导入（CSV、Excel、TXT）
- **F002**：支持多文件批量导入，自动合并相同结构的文件
- **F003**：支持拖拽文件导入功能
- **F004**：支持数据预览，显示前N行数据结构
- **F005**：支持自定义分隔符和编码设置

### 2.2 数据处理
- **F006**：支持多文件自动合并功能
- **F007**：支持合并后自动去重处理
- **F008**：支持交集运算（A ∩ B）
- **F009**：支持并集运算（A ∪ B）
- **F010**：支持差集运算（A - B, B - A）
- **F011**：支持多字段联合运算
- **F012**：支持自定义比较规则设置

### 2.3 结果导出
- **F013**：支持执行前选择输出路径
- **F014**：支持多种导出格式（CSV、Excel、TXT）
- **F015**：支持分批输出结果，防止内存占用过多
- **F016**：支持导出到指定路径
- **F017**：支持结果预览和统计信息显示

### 2.4 进度监控
- **F018**：实时显示执行进度，包括执行行数
- **F019**：显示处理时间和预估剩余时间
- **F020**：显示处理速度（行/秒）
- **F021**：显示内存使用情况
- **F022**：显示错误信息和处理状态

### 2.5 用户界面
- **F023**：简洁现代的设计风格
- **F024**：响应式布局，适配不同屏幕尺寸
- **F025**：直观的操作流程，减少用户学习成本
- **F026**：清晰的视觉反馈，操作状态明确
- **F027**：支持深色模式切换
- **F028**：适配Windows原生UI风格

## 3. 非功能需求

### 3.1 性能需求
- **NF001**：数据导入速度：1000万行数据 ≤ 5分钟
- **NF002**：多文件合并去重速度：1000万行数据 ≤ 3分钟
- **NF003**：交并差运算速度：1000万行数据 ≤ 3分钟
- **NF004**：数据导出速度：1000万行数据 ≤ 4分钟
- **NF005**：内存占用峰值 ≤ 1GB
- **NF006**：界面操作响应时间 ≤ 100ms
- **NF007**：进度更新频率：每10,000行或1秒更新一次

### 3.2 可靠性需求
- **NF008**：数据处理准确性：100%
- **NF009**：错误处理机制完善，防止程序崩溃
- **NF010**：支持断点续传，处理过程中断后可恢复
- **NF011**：临时文件自动清理，避免磁盘空间浪费

### 3.3 兼容性需求
- **NF012**：优先支持Windows 10/11平台
- **NF013**：兼顾支持macOS和Linux平台
- **NF014**：支持32位和64位系统
- **NF015**：支持不同版本的Python环境

### 3.4 可用性需求
- **NF016**：用户界面友好，操作简单直观
- **NF017**：提供详细的操作指引和帮助文档
- **NF018**：支持快捷键操作
- **NF019**：提供配置保存和恢复功能

## 4. 技术架构

### 4.1 系统架构
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  前端界面层     │     │  业务逻辑层     │     │  数据处理层     │
│  - Electron     │────▶│  - Python       │────▶│  - SQLite       │
│  - Vue 3        │     │  - 任务管理     │     │  - 索引优化     │
│  - Vite         │     │  - 进度监控     │     │  - 分块处理     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 4.2 核心模块
- **数据导入模块**：文件选择、格式检测、数据解析
- **多文件合并模块**：文件批量处理、结构统一、数据合并
- **去重处理模块**：SQLite临时表、去重算法
- **交并差运算模块**：SQLite查询优化、索引管理
- **分批输出模块**：流式输出、内存监控、错误处理
- **实时进度模块**：WebSocket通信、进度计算、统计信息
- **配置管理模块**：用户配置保存、默认值设置

### 4.3 技术依赖
| 类别 | 技术/库 | 版本 | 用途 |
|------|---------|------|------|
| 前端框架 | Electron | v20+ | 桌面应用打包 |
| 前端框架 | Vue 3 | v3.2+ | 前端界面开发 |
| 前端构建 | Vite | v4.0+ | 前端构建工具 |
| UI组件 | Element Plus | v2.0+ | 前端UI组件 |
| 状态管理 | Pinia | v2.0+ | 前端状态管理 |
| 后端语言 | Python | v3.8+ | 业务逻辑处理 |
| 数据处理 | pandas | v1.5+ | 数据解析和处理 |
| 数据库 | SQLite | 内置 | 数据存储和运算 |
| 通信 | WebSocket | - | 实时进度通信 |
| 打包工具 | electron-builder | v23.0+ | Windows应用打包 |

## 5. 优化方案

### 5.1 执行效率优化方案

#### 5.1.1 算法优化
- **分块处理**：大文件分块读取，每块10-100万行
- **索引策略**：为关键字段创建复合索引，加速交并差运算
- **查询优化**：使用SQLite的`EXCEPT`、`UNION`、`INTERSECT`操作，避免全表扫描
- **并行处理**：多文件导入时使用线程池，充分利用多核CPU

#### 5.1.2 SQLite优化
- **PRAGMA配置**：
  ```sql
  PRAGMA journal_mode = WAL;
  PRAGMA synchronous = NORMAL;
  PRAGMA cache_size = -64000; -- 64MB缓存
  PRAGMA temp_store = MEMORY;
  ```
- **事务管理**：批量操作使用事务，减少磁盘I/O
- **临时表优化**：使用内存临时表，加速中间结果处理
- **统计信息更新**：定期运行`ANALYZE`，优化查询计划

#### 5.1.3 数据结构优化
- **使用适当的数据类型**：减少存储空间，提高查询速度
- **字段压缩**：对于长文本字段，考虑使用压缩存储
- **分区表**：对于超大表，考虑使用分区策略

### 5.2 代码鲁棒性提升方案

#### 5.2.1 错误处理机制
- **分层错误处理**：前端、后端、数据库层分别处理错误
- **异常捕获**：使用try-except捕获所有可能的异常
- **错误码系统**：定义统一的错误码，便于定位问题
- **日志系统**：详细记录错误信息，包括上下文和堆栈跟踪

#### 5.2.2 边界情况处理
- **空文件处理**：优雅处理空文件或格式错误的文件
- **内存不足处理**：检测内存使用，自动调整批处理大小
- **磁盘空间不足**：监控磁盘空间，及时提示用户
- **网络中断处理**：WebSocket连接断开时的重连机制

#### 5.2.3 输入验证
- **文件格式验证**：检测文件格式和编码，避免解析错误
- **数据完整性验证**：检查数据结构一致性，避免合并错误
- **路径验证**：验证输出路径权限和可用性
- **参数验证**：验证所有用户输入参数的有效性

#### 5.2.4 恢复机制
- **断点续传**：记录处理进度，支持中断后恢复
- **自动重试**：对于网络或磁盘临时错误，自动重试
- **数据备份**：重要操作前创建数据备份，防止数据丢失

### 5.3 内存管理和释放方案

#### 5.3.1 数据分块处理
- **动态批处理大小**：根据系统内存自动调整批处理大小
- **流式处理**：边读取边处理，避免一次性加载全部数据
- **结果缓存**：合理设置结果缓存大小，避免内存溢出

#### 5.3.2 内存监控
- **实时内存监控**：使用`psutil`库监控内存使用情况
- **内存阈值设置**：设置内存使用阈值，超过时自动调整策略
- **内存使用报告**：向用户显示内存使用情况，提高透明度

#### 5.3.3 资源释放
- **文件句柄管理**：使用`with`语句自动关闭文件
- **数据库连接管理**：使用连接池，及时关闭空闲连接
- **临时文件清理**：处理完成后自动清理临时文件和表
- **缓存清理**：定期清理不必要的缓存数据

#### 5.3.4 垃圾回收优化
- **手动垃圾回收**：在适当的时机手动触发垃圾回收
- **对象生命周期管理**：减少对象创建，复用对象
- **内存泄漏检测**：使用内存分析工具检测潜在的内存泄漏

#### 5.3.5 缓冲区管理
- **合理设置缓冲区大小**：平衡内存使用和I/O性能
- **缓冲区复用**：避免频繁创建和销毁缓冲区
- **异步I/O**：使用异步I/O，减少阻塞等待

### 5.6 低配置电脑优化方案

#### 5.6.1 系统配置检测
- **自动检测**：启动时检测CPU核心数和内存大小
- **配置评估**：根据检测结果评估系统性能等级
- **优化策略选择**：根据性能等级自动选择合适的优化策略

#### 5.6.2 针对低CPU的优化
- **动态线程数调整**：根据CPU核心数自动调整线程数，低配置时使用单线程
- **任务优先级管理**：将数据处理任务设置为合理优先级，避免系统卡顿
- **后台处理优化**：在低CPU情况下，降低后台任务占用
- **渐进式处理**：将大任务分解为更小的子任务，逐步完成

#### 5.6.3 针对低内存的优化
- **更小的批处理大小**：低内存时自动使用更小的批处理大小（如10,000行/批）
- **更激进的内存释放**：更频繁地触发垃圾回收，及时释放不再使用的内存
- **磁盘交换策略**：当内存不足时，使用临时文件作为交换空间
- **内存使用限制**：设置严格的内存使用上限，避免内存溢出
- **数据压缩存储**：在内存中使用压缩数据结构，减少内存占用

#### 5.6.4 综合优化策略
- **低配置模式**：提供专门的低配置模式，关闭所有非必要的功能
- **用户可调节的性能模式**：提供"快速"、"平衡"、"节能"等模式供用户选择
- **进度自动保存**：更频繁地保存处理进度，避免因内存不足导致的进度丢失
- **错误恢复增强**：在低配置环境下，增强错误恢复能力，避免程序崩溃

#### 5.6.5 用户体验优化
- **低配置提示**：检测到低配置时，向用户提供优化建议
- **处理时间预估**：根据系统配置，更准确地预估处理时间
- **性能监控面板**：提供详细的性能监控面板，让用户了解系统状态
- **可暂停/恢复**：支持随时暂停和恢复处理，方便用户在需要时释放系统资源

### 5.4 前端操作体验优化方案

#### 5.4.1 拖拽功能
- **文件拖拽**：支持拖拽文件到界面添加
- **文件夹拖拽**：支持拖拽文件夹，自动扫描并添加所有符合条件的文件
- **拖拽反馈**：提供清晰的拖拽状态反馈，包括可接受/不可接受状态
- **拖拽区域**：设计明显的拖拽区域，提高用户操作成功率

#### 5.4.2 交互流程优化
- **向导式操作**：提供分步向导，引导用户完成复杂操作
- **批量操作**：支持批量选择和批量处理文件
- **快捷键支持**：提供常用操作的快捷键，提高操作效率
- **操作撤销/重做**：支持操作的撤销和重做功能

#### 5.4.3 界面响应速度
- **异步操作**：所有耗时操作使用异步处理，避免界面卡顿
- **加载状态**：为所有异步操作提供加载状态指示
- **虚拟滚动**：对于大量文件列表，使用虚拟滚动，提高渲染性能
- **防抖和节流**：对频繁触发的事件使用防抖和节流，减少不必要的计算

#### 5.4.4 用户反馈
- **操作成功提示**：所有操作提供明确的成功提示
- **进度条动画**：使用平滑的进度条动画，提高视觉体验
- **声音反馈**：可选的声音反馈，增强操作确认感
- **触觉反馈**：在支持的设备上提供触觉反馈

#### 5.4.5 个性化设置
- **主题切换**：支持浅色/深色主题，适应不同使用环境
- **布局定制**：允许用户调整界面布局，满足个性化需求
- **默认值设置**：记住用户的操作习惯，自动应用默认设置
- **快捷键定制**：允许用户自定义快捷键

### 5.5 进度提示和错误提示方案

#### 5.5.1 实时进度显示
- **详细进度条**：显示总体进度和当前阶段进度
- **执行行数统计**：实时显示已处理的行数和总行数
- **处理速度显示**：显示当前处理速度（行/秒）
- **时间估计**：基于当前速度，估计剩余处理时间

#### 5.5.2 处理阶段提示
- **阶段指示器**：清晰显示当前处于哪个处理阶段（导入、合并、运算、导出）
- **阶段详情**：每个阶段提供详细的子任务进度
- **瓶颈识别**：自动识别处理瓶颈，提供优化建议

#### 5.5.3 错误信息展示
- **错误类型分类**：根据错误类型提供不同的处理建议
- **错误定位**：精确定位错误位置，包括文件名和行号
- **错误解决方案**：为常见错误提供具体的解决方案
- **错误详情展开**：允许用户展开查看详细的错误信息

#### 5.5.4 操作取消和重试
- **取消按钮**：所有长时间操作提供取消按钮
- **取消确认**：取消操作时提供确认对话框，避免误操作
- **重试机制**：错误发生后提供一键重试功能
- **重试次数限制**：设置合理的重试次数限制，避免无限重试

#### 5.5.5 操作流程优化
- **操作前验证**：执行操作前验证所有必要条件
- **操作后总结**：操作完成后提供详细的总结报告
- **历史记录**：保存操作历史，便于用户查看和重复操作
- **操作模板**：允许用户保存常用操作配置为模板

## 6. 实现路径

### 6.1 开发阶段
1. **环境搭建**：配置开发环境，安装依赖
2. **基础架构**：搭建前端和后端框架，配置WebSocket通信
3. **核心功能实现**：
   - 数据导入和多文件合并功能
   - 去重处理和交并差运算
   - 分批输出结果功能
   - 实时进度显示功能
4. **性能优化**：应用各种优化策略，测试千万级数据处理
5. **界面设计**：实现现代简洁的用户界面，适配Windows风格
6. **测试验证**：测试数据处理性能和准确性
7. **打包发布**：配置Windows打包，生成可执行文件

### 6.2 关键技术点
- **SQLite优化**：索引设计、事务处理、PRAGMA配置
- **内存管理**：分块处理、流式读写、内存监控
- **并行处理**：多线程导入、任务队列调度
- **实时通信**：WebSocket消息压缩、心跳机制
- **Windows打包**：electron-builder配置、安装包生成

## 7. 性能预期

### 7.1 处理速度
| 操作 | 数据量 | 预期时间 |
|------|--------|----------|
| 数据导入 | 1000万行 | 2-5分钟 |
| 多文件合并去重 | 1000万行 | 1-3分钟 |
| 交并差运算 | 1000万行 | 1-3分钟 |
| 数据导出 | 1000万行 | 2-4分钟 |

### 7.2 资源占用
- **内存**：峰值 ≤ 1GB
- **CPU**：单核心利用率 ≤ 80%
- **磁盘**：临时文件 ≤ 5GB（处理完成后自动清理）

### 7.3 用户体验
- **界面响应**：操作响应时间 ≤ 100ms
- **进度显示**：实时更新，每10,000行或1秒更新一次
- **操作流畅度**：无卡顿现象，即使在处理大量数据时

## 8. 交付物

### 8.1 软件交付物
- **Windows安装包**（.exe）
- **Windows免安装版本**（.zip）
- **源代码**（GitHub仓库）

### 8.2 文档交付物
- **用户操作手册**：详细的功能说明和操作步骤
- **技术架构文档**：系统设计和技术实现细节
- **性能测试报告**：千万级数据处理性能测试结果



## 11. 总结

本需求文档详细描述了本地千万级数据交并差运算工具的功能需求、非功能需求、技术架构和实现路径。通过Python + SQLite作为后端，Electron + Vue 3 + Vite作为前端，实现了一个高性能、用户友好的桌面应用程序，能够处理千万级数据的交并差运算，支持多文件合并去重、实时进度显示和分批输出结果，优先支持Windows平台，满足用户的核心需求。

该工具通过合理的性能优化策略，如分块处理、索引优化、实时监控等，确保了在处理大规模数据时的稳定性和效率，同时保持了界面的现代简洁和操作的流畅性，为用户提供了良好的使用体验。